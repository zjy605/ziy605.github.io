<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å°è¯´é˜…è¯»å™¨ - ç²¾ç®€ç‰ˆ</title>
  <style>
    body {
      background-color: #000;
      color: #fff;
      font-family: "Microsoft YaHei", "SimSun", sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #header {
      padding: 15px 20px;
      background: #111;
      border-bottom: 1px solid #333;
    }
    #controls {
      margin-bottom: 8px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #fileInput {
      color: white;
      background: #333;
      border: 1px solid #555;
      padding: 6px 10px;
      border-radius: 4px;
    }
    button {
      background: #444;
      color: white;
      border: 1px solid #666;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #555;
    }

    .container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    #tocPanel {
      width: 250px;
      background: #1a1a1a;
      padding: 15px;
      overflow-y: auto;
      border-right: 1px solid #333;
      flex-shrink: 0;
      display: none; /* é»˜è®¤éšè— */
    }
    #tocPanel h3 {
      margin-top: 0;
      margin-bottom: 12px;
      color: #ccc;
    }
    #tocList {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #tocList li {
      margin-bottom: 6px;
    }
    #tocList a {
      color: #66ccff;
      text-decoration: none;
      font-size: 14px;
      display: block;
      padding: 4px 6px;
      border-radius: 3px;
    }
    #tocList a:hover {
      background: #2a2a2a;
    }

    #contentPanel {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    .chapter {
      margin-bottom: 24px;
    }
    .chapter-title {
      font-size: 20px;
      font-weight: bold;
      color: #4dffcc;
      margin: 20px 0 12px 0;
      padding-bottom: 6px;
      border-bottom: 1px solid #333;
    }
    .chapter-content {
      white-space: pre-wrap;
      line-height: 1.7;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <div id="header">
    <div id="controls">
      <input type="file" id="fileInput" accept=".txt" />
      <button onclick="toggleTheme()">åˆ‡æ¢æµ…è‰²/æ·±è‰²</button>
      <button onclick="toggleToc()">æ˜¾ç¤º/éšè—ç›®å½•</button>
    </div>
    <div>ä¸Šä¼ å°è¯´ TXT æ–‡ä»¶ï¼Œè‡ªåŠ¨è¯†åˆ«ç« èŠ‚å¹¶ç”Ÿæˆå¯æŠ˜å ç›®å½•</div>
  </div>

  <div class="container">
    <div id="tocPanel">
      <h3>ğŸ“– ç›®å½•</h3>
      <ul id="tocList"></ul>
    </div>
    <div id="contentPanel">
      <p>è¯·ä¸Šä¼ ä¸€ä¸ª .txt å°è¯´æ–‡ä»¶</p>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const tocPanel = document.getElementById('tocPanel');
    const tocList = document.getElementById('tocList');
    const contentPanel = document.getElementById('contentPanel');

    let isDark = true;

    // æ”¯æŒçš„ç« èŠ‚æ­£åˆ™ï¼ˆä¸­æ–‡ã€è‹±æ–‡ã€æ•°å­—ï¼‰
    const chapterPatterns = [
      /^(ç¬¬[é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒ\d]+ç« \s*.+)$/i,
      /^(Chapter\s+\d+\s*:?\s*.+)$/i,
      /^(ç¬¬\s*\d+\s*ç« \s*.+)$/i,
      /^(å·\s*[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å\d]+\s*[:ï¼š]?\s*.+)$/i,
    ];

    function isChapterLine(line) {
      return chapterPatterns.some(pattern => pattern.test(line.trim()));
    }

    function parseChapters(text) {
      const lines = text.split('\n');
      const chapters = [];
      let currentChapter = null;

      for (let line of lines) {
        if (isChapterLine(line)) {
          if (currentChapter) {
            chapters.push(currentChapter);
          }
          currentChapter = {
            title: line.trim(),
            content: ''
          };
        } else {
          if (currentChapter) {
            currentChapter.content += line + '\n';
          } else {
            if (!chapters.intro) chapters.intro = '';
            chapters.intro += line + '\n';
          }
        }
      }
      if (currentChapter) {
        chapters.push(currentChapter);
      }
      return chapters;
    }

    function renderContent(chapters) {
      contentPanel.innerHTML = '';
      tocList.innerHTML = '';

      // æ¸²æŸ“å‰ç½®å†…å®¹ï¼ˆå¦‚ä¹¦åã€ä½œè€…ç­‰ï¼‰
      if (chapters.intro) {
        const introDiv = document.createElement('pre');
        introDiv.className = 'chapter-content';
        introDiv.textContent = chapters.intro;
        contentPanel.appendChild(introDiv);
      }

      if (chapters.length === 0 || (chapters.length === 1 && !chapters[0].title)) {
        // æ— æœ‰æ•ˆç« èŠ‚ï¼šå…¨æ–‡å½“ä½œä¸€æ®µ
        const allText = chapters.intro || (chapters[0]?.content || '');
        const pre = document.createElement('pre');
        pre.className = 'chapter-content';
        pre.textContent = allText;
        contentPanel.appendChild(pre);
        tocPanel.style.display = 'none';
        return;
      }

      // æœ‰ç« èŠ‚ï¼šç”Ÿæˆç›®å½• + å†…å®¹
      tocPanel.style.display = 'block'; // å…ˆæ˜¾ç¤ºï¼Œç”¨æˆ·å¯æ‰‹åŠ¨éšè—

      chapters.forEach((chap, index) => {
        const id = `chap-${index}`;
        
        // ç›®å½•é¡¹
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `#${id}`;
        a.textContent = chap.title.length > 40 ? chap.title.substring(0, 38) + '...' : chap.title;
        a.onclick = (e) => {
          e.preventDefault();
          document.getElementById(id).scrollIntoView({ behavior: 'smooth', block: 'start' });
        };
        li.appendChild(a);
        tocList.appendChild(li);

        // æ­£æ–‡ç« èŠ‚
        const div = document.createElement('div');
        div.className = 'chapter';
        div.id = id;

        const titleEl = document.createElement('div');
        titleEl.className = 'chapter-title';
        titleEl.textContent = chap.title;

        const contentEl = document.createElement('pre');
        contentEl.className = 'chapter-content';
        contentEl.textContent = chap.content;

        div.appendChild(titleEl);
        div.appendChild(contentEl);
        contentPanel.appendChild(div);
      });

      // é»˜è®¤éšè—ç›®å½•ï¼ˆå³ä½¿æœ‰ç« èŠ‚ï¼‰
      tocPanel.style.display = 'none';
    }

    fileInput.addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        const text = e.target.result;
        const chapters = parseChapters(text);
        renderContent(chapters);
      };
      reader.readAsText(file, 'UTF-8');
    });

    function toggleToc() {
      tocPanel.style.display = tocPanel.style.display === 'none' ? 'block' : 'none';
    }

    function toggleTheme() {
      isDark = !isDark;
      document.body.style.backgroundColor = isDark ? '#000' : '#fff';
      document.body.style.color = isDark ? '#fff' : '#000';
      const panelBg = isDark ? '#1a1a1a' : '#f5f5f5';
      const textColor = isDark ? '#fff' : '#000';
      const linkColor = isDark ? '#66ccff' : '#0066cc';
      tocPanel.style.backgroundColor = panelBg;
      tocPanel.style.color = textColor;
      tocList.querySelectorAll('a').forEach(a => a.style.color = linkColor);
      const contentEls = contentPanel.querySelectorAll('.chapter-content, .chapter-title');
      contentEls.forEach(el => el.style.color = textColor);
    }
  </script>
</body>
</html>